<script>
(function() {

  /* --------------------------------------------
     ELEMENT REFERENCES
  ---------------------------------------------*/
  const video = document.getElementById("video");
  const overlayWrap = document.getElementById("overlayWrap");
  const overlay = document.getElementById("overlay");
  const captureCanvas = document.getElementById("capture");
  const startOverlay = document.getElementById("startOverlay");
  const startBtn = document.getElementById("startBtn");
  const shutterBtn = document.getElementById("shutterBtn");
  const burnBtn = document.getElementById("burnBtn");
  const ghostBtn = document.getElementById("ghostBtn");
  const chooser = document.getElementById("chooser");
  const chooserClose = document.getElementById("chooserClose");
  const toast = document.getElementById("toast");
  const opacitySlider = document.getElementById("opacitySlider");

  let stream = null;
  let currentBlend = "lighten";
  let currentOpacity = 1;

  /* --------------------------------------------
     TOAST MESSAGE
  ---------------------------------------------*/
  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.classList.remove("show"), 1500);
  }

  /* --------------------------------------------
     PRELOAD GHOST IMAGES
  ---------------------------------------------*/
  [
    "ghostwoman.png",
    "ghostgirl.png",
    "ghostman.png",
    "ghostscream.png",
    "ghosthand.png",
    "ghostshadow.png"
  ].forEach(src => {
    const im = new Image();
    im.src = src;
  });

  /* --------------------------------------------
     START CAMERA
  ---------------------------------------------*/
  async function startCamera() {
    try {
      let got = null;

      // Try environment camera first
      const attempts = [
        { video: { facingMode: "environment" }, audio: false },
        { video: true, audio: false }
      ];

      for (const opt of attempts) {
        try {
          got = await navigator.mediaDevices.getUserMedia(opt);
          break;
        } catch (e)
